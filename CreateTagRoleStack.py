from aws_cdk import (
    aws_iam as iam,
    aws_servicecatalog as servicecatalog,
    aws_resourceexplorer2 as resourceexplorer2
)
from constructs import Construct

class CreateTagRoleStack(servicecatalog.ProductStack):
    def __init__(
        self,
        scope: Construct,
        id: str,
        integration_account_id: str,
        asset_bucket: str = None,
        **kwargs,
    ) -> None:

        super().__init__(scope, id, asset_bucket=asset_bucket, **kwargs)


        ########################################
        ###### Tag Resources accounts Role ######
        ########################################
        
        resource_tag_document = iam.PolicyDocument(
            statements=[
                iam.PolicyStatement(
                    actions=[
                    "application-autoscaling:ListTagsForResource",
                    "application-autoscaling:TagResource",
                    "application-autoscaling:UntagResource",
                    "applicationinsights:ListTagsForResource",
                    "autoscaling:CreateOrUpdateTags",
                    "autoscaling:DeleteTags",
                    "autoscaling:DescribeTags",
                    "cloudformation:DescribeStacks",
				    "cloudformation:TagResource",
                    "cloudformation:UntagResource",
                    "cloudfront:ListTagsForResource",
                    "cloudfront:TagResource",
                    "cloudfront:UntagResource",
                    "cloudwatch:ListTagsForResource",
                    "cloudwatch:TagResource",
                    "cloudwatch:UntagResource",
                    "dax:ListTags",
                    "dax:TagResource",
                    "dax:UntagResource",
                    "dynamodb:ListTagsOfResource",
                    "dynamodb:TagResource",
                    "dynamodb:UntagResource",
                    "ec2:CreateTags",
                    "ec2:DeleteTags",
                    "ec2:DescribeTags",
                    "ecr-public:TagResource",
                    "ecr-public:UntagResource",
                    "ecr:TagResource",
                    "ecr:UntagResource",
                    "ecs:ListTagsForResource",
                    "ecs:TagResource",
                    "ecs:UntagResource",
                    "eks:ListTagsForResource",
                    "eks:TagResource",
                    "eks:UntagResource",
                    "elasticache:AddTagsToResource",
                    "elasticache:ListTagsForResource",
                    "elasticache:RemoveTagsFromResource",
                    "elasticbeanstalk:AddTags",
                    "elasticbeanstalk:ListTagsForResource",
                    "elasticbeanstalk:RemoveTags",
                    "elasticbeanstalk:UpdateTagsForResource",
                    "elasticfilesystem:CreateTags",
                    "elasticfilesystem:DeleteTags",
                    "elasticfilesystem:DescribeTags",
                    "elasticfilesystem:ListTagsForResource",
                    "elasticfilesystem:TagResource",
                    "elasticfilesystem:UntagResource",
                    "elasticloadbalancing:AddTags",
                    "elasticloadbalancing:DescribeTags",
                    "elasticloadbalancing:RemoveTags",
                    "elasticmapreduce:AddTags",
                    "elasticmapreduce:RemoveTags",
                    "emr-containers:ListTagsForResource",
                    "emr-containers:TagResource",
                    "emr-containers:UntagResource",
                    "emr-serverless:ListTagsForResource",
                    "emr-serverless:TagResource",
                    "emr-serverless:UntagResource",
                    "events:ListTagsForResource",
                    "events:TagResource",
                    "events:UntagResource",
                    "evidently:ListTagsForResource",
                    "evidently:TagResource",
                    "evidently:UntagResource",
                    "glue:GetTags",
                    "glue:TagResource",
                    "glue:UntagResource",
                    "iam:ListInstanceProfileTags",
                    "iam:ListMFADeviceTags",
                    "iam:ListOpenIDConnectProviderTags",
                    "iam:ListPolicyTags",
                    "iam:ListRoleTags",
                    "iam:ListSAMLProviderTags",
                    "iam:ListServerCertificateTags",
                    "iam:ListUserTags",
                    "iam:TagInstanceProfile",
                    "iam:TagMFADevice",
                    "iam:TagOpenIDConnectProvider",
                    "iam:TagPolicy",
                    "iam:TagRole",
                    "iam:TagSAMLProvider",
                    "iam:TagServerCertificate",
                    "iam:TagUser",
                    "iam:UntagInstanceProfile",
                    "iam:UntagMFADevice",
                    "iam:UntagOpenIDConnectProvider",
                    "iam:UntagPolicy",
                    "iam:UntagRole",
                    "iam:UntagSAMLProvider",
                    "iam:UntagServerCertificate",
                    "iam:UntagUser",
                    "iotevents:ListTagsForResource",
                    "iotevents:TagResource",
                    "iotevents:UntagResource",
                    "kinesis:AddTagsToStream",
                    "kinesis:ListTagsForStream",
                    "kinesis:RemoveTagsFromStream",
                    "kinesisanalytics:ListTagsForResource",
                    "kinesisanalytics:TagResource",
                    "kinesisanalytics:UntagResource",
                    "kinesisvideo:ListTagsForResource",
                    "kinesisvideo:ListTagsForStream",
                    "kinesisvideo:TagResource",
                    "kinesisvideo:TagStream",
                    "kinesisvideo:UntagResource",
                    "kinesisvideo:UntagStream",
                    "kms:ListResourceTags",
                    "kms:TagResource",
                    "kms:UntagResource",
                    "logs:ListTagsForResource",
                    "logs:ListTagsLogGroup",
                    "logs:TagLogGroup",
                    "logs:TagResource",
                    "logs:UntagLogGroup",
                    "logs:UntagResource",
                    "mediaconnect:ListTagsForResource",
                    "mediaconnect:TagResource",
                    "mediaconnect:UntagResource",
                    "organizations:DescribeOrganization",
                    "organizations:ListTagsForResource",
                    "pipes:ListTagsForResource",
                    "pipes:TagResource",
                    "pipes:UntagResource",
                    "rds:AddTagsToResource",
                    "rds:ListTagsForResource",
                    "rds:RemoveTagsFromResource",
                    "resource-explorer-2:CreateIndex",
                    "resource-explorer-2:CreateView",
                    "resource-explorer-2:DeleteIndex",
                    "resource-explorer-2:DeleteView",
                    "resource-explorer-2:GetDefaultView",
                    "resource-explorer-2:GetIndex",
                    "resource-explorer-2:GetView",
                    "resource-explorer-2:ListIndexes",
                    "resource-explorer-2:ListTagsForResource",
                    "resource-explorer-2:ListViews",
                    "resource-explorer-2:Search",
                    "resource-explorer-2:TagResource",
                    "resource-explorer-2:UntagResource",
                    "resourcegroupstaggingapi:GetResources",
                    "resourcegroupstaggingapi:TagResources",
                    "resourcegroupstaggingapi:UntagResources",
                    "rum:ListTagsForResource",
                    "rum:TagResource",
                    "rum:UntagResource",
                    "s3:GetBucketTagging",
                    "s3:ListTagsForResource",
                    "s3:PutBucketTagging",
                    "s3:ReplicateTags",
                    "s3:TagResource",
                    "s3:UntagResource",
                    "sagemaker-geospatial:ListTagsForResource",
                    "sagemaker-geospatial:TagResource",
                    "sagemaker-geospatial:UntagResource",
                    "sagemaker:AddTags",
                    "sagemaker:DeleteTags",
                    "sagemaker:ListTags",
                    "scheduler:ListTagsForResource",
                    "scheduler:TagResource",
                    "scheduler:UntagResource",
                    "schemas:ListTagsForResource",
                    "schemas:TagResource",
                    "schemas:UntagResource",
                    "secretsmanager:DescribeSecret",
                    "secretsmanager:TagResource",
                    "secretsmanager:UntagResource",
                    "sns:ListTagsForResource",
                    "sns:TagResource",
                    "sns:UntagResource",
                    "sqs:ListQueueTags",
                    "sqs:TagQueue",
                    "sqs:UntagQueue",
                    "ssm:GetParameters",
                    "ssm:AddTagsToResource",
                    "ssm:ListTagsForResource",
                    "ssm:RemoveTagsFromResource",
                    "states:ListTagsForResource",
                    "states:TagResource",
                    "states:UntagResource",
                    "storagegateway:AddTagsToResource",
                    "storagegateway:ListTagsForResource",
                    "storagegateway:RemoveTagsFromResource",
                    "sts:GetCallerIdentity",
                    "swf:ListTagsForResource",
                    "swf:TagResource",
                    "swf:UntagResource",
                    "synthetics:ListTagsForResource",
                    "synthetics:TagResource",
                    "synthetics:UntagResource",
                    "tag:GetResources",
                    "tag:TagResources",
                    "tag:UntagResources",
                    "transfer:ListTagsForResource",
                    "transfer:TagResource",
                    "transfer:UntagResource",
                    "waf-regional:ListTagsForResource",
                    "waf-regional:TagResource",
                    "waf-regional:UntagResource",
                    "waf:ListTagsForResource",
                    "waf:TagResource",
                    "waf:UntagResource",
                    "wafv2:ListTagsForResource",
                    "wafv2:TagResource",
                    "wafv2:UntagResource",
                    "workspaces:CreateTags",
                    "workspaces:DeleteTags",
                    "workspaces:DescribeTags",
                    "xray:ListTagsForResource",
                    "xray:TagResource",
                    "xray:UntagResource"],
                    resources=["*"],
                    sid="TagActions"),
            ])

        iam.Role(
            self,
            id="AccountsTagRole",
            assumed_by=iam.ArnPrincipal(
                f"arn:aws:iam::{integration_account_id}:role/lz-integration-AutoTaggingLambdaRole"
            ),
            inline_policies={"TagPolicy": resource_tag_document},
            managed_policies=[iam.ManagedPolicy.from_aws_managed_policy_name("ResourceGroupsTaggingAPITagUntagSupportedResources")],
            role_name="lz-integration-Accounts-Tag-Role",
        )

        ResourceExplorerIndex = resourceexplorer2.CfnIndex(
            self, 
            "LocalIndex",
            type="LOCAL",
            )